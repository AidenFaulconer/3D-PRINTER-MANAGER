/**
 * @license
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const A=Symbol("Comlink.proxy"),G=Symbol("Comlink.endpoint"),H=Symbol("Comlink.releaseProxy"),E=Symbol("Comlink.finalizer"),P=Symbol("Comlink.thrown"),S=t=>typeof t=="object"&&t!==null||typeof t=="function",W={canHandle:t=>S(t)&&t[A],serialize(t){const{port1:n,port2:e}=new MessageChannel;return k(t,n),[e,[e]]},deserialize(t){return t.start(),j(t)}},V={canHandle:t=>S(t)&&P in t,serialize({value:t}){let n;return t instanceof Error?n={isError:!0,value:{message:t.message,name:t.name,stack:t.stack}}:n={isError:!1,value:t},[n,[]]},deserialize(t){throw t.isError?Object.assign(new Error(t.value.message),t.value):t.value}},R=new Map([["proxy",W],["throw",V]]);function _(t,n){for(const e of t)if(n===e||e==="*"||e instanceof RegExp&&e.test(n))return!0;return!1}function k(t,n=globalThis,e=["*"]){n.addEventListener("message",function u(s){if(!s||!s.data)return;if(!_(e,s.origin)){console.warn(`Invalid origin '${s.origin}' for comlink proxy`);return}const{id:i,type:y,path:l}=Object.assign({path:[]},s.data),f=(s.data.argumentList||[]).map(m);let o;try{const a=l.slice(0,-1).reduce((r,d)=>r[d],t),c=l.reduce((r,d)=>r[d],t);switch(y){case"GET":o=c;break;case"SET":a[l.slice(-1)[0]]=m(s.data.value),o=!0;break;case"APPLY":o=c.apply(a,f);break;case"CONSTRUCT":{const r=new c(...f);o=Y(r)}break;case"ENDPOINT":{const{port1:r,port2:d}=new MessageChannel;k(t,d),o=B(r,[r])}break;case"RELEASE":o=void 0;break;default:return}}catch(a){o={value:a,[P]:0}}Promise.resolve(o).catch(a=>({value:a,[P]:0})).then(a=>{const[c,r]=z(a);n.postMessage(Object.assign(Object.assign({},c),{id:i}),r),y==="RELEASE"&&(n.removeEventListener("message",u),O(n),E in t&&typeof t[E]=="function"&&t[E]())}).catch(a=>{const[c,r]=z({value:new TypeError("Unserializable return value"),[P]:0});n.postMessage(Object.assign(Object.assign({},c),{id:i}),r)})}),n.start&&n.start()}function F(t){return t.constructor.name==="MessagePort"}function O(t){F(t)&&t.close()}function j(t,n){const e=new Map;return t.addEventListener("message",function(s){const{data:i}=s;if(!i||!i.id)return;const y=e.get(i.id);if(y)try{y(i)}finally{e.delete(i.id)}}),M(t,e,[],n)}function b(t){if(t)throw new Error("Proxy has been released and is not useable")}function L(t){return x(t,new Map,{type:"RELEASE"}).then(()=>{O(t)})}const p=new WeakMap,w="FinalizationRegistry"in globalThis&&new FinalizationRegistry(t=>{const n=(p.get(t)||0)-1;p.set(t,n),n===0&&L(t)});function v(t,n){const e=(p.get(n)||0)+1;p.set(n,e),w&&w.register(t,n,t)}function U(t){w&&w.unregister(t)}function M(t,n,e=[],u=function(){}){let s=!1;const i=new Proxy(u,{get(y,l){if(b(s),l===H)return()=>{U(i),L(t),n.clear(),s=!0};if(l==="then"){if(e.length===0)return{then:()=>i};const f=x(t,n,{type:"GET",path:e.map(o=>o.toString())}).then(m);return f.then.bind(f)}return M(t,n,[...e,l])},set(y,l,f){b(s);const[o,a]=z(f);return x(t,n,{type:"SET",path:[...e,l].map(c=>c.toString()),value:o},a).then(m)},apply(y,l,f){b(s);const o=e[e.length-1];if(o===G)return x(t,n,{type:"ENDPOINT"}).then(m);if(o==="bind")return M(t,n,e.slice(0,-1));const[a,c]=I(f);return x(t,n,{type:"APPLY",path:e.map(r=>r.toString()),argumentList:a},c).then(m)},construct(y,l){b(s);const[f,o]=I(l);return x(t,n,{type:"CONSTRUCT",path:e.map(a=>a.toString()),argumentList:f},o).then(m)}});return v(i,t),i}function q(t){return Array.prototype.concat.apply([],t)}function I(t){const n=t.map(z);return[n.map(e=>e[0]),q(n.map(e=>e[1]))]}const N=new WeakMap;function B(t,n){return N.set(t,n),t}function Y(t){return Object.assign(t,{[A]:!0})}function z(t){for(const[n,e]of R)if(e.canHandle(t)){const[u,s]=e.serialize(t);return[{type:"HANDLER",name:n,value:u},s]}return[{type:"RAW",value:t},N.get(t)||[]]}function m(t){switch(t.type){case"HANDLER":return R.get(t.name).deserialize(t.value);case"RAW":return t.value}}function x(t,n,e,u){return new Promise(s=>{const i=X();n.set(i,s),t.start&&t.start(),t.postMessage(Object.assign({id:i},e),u)})}function X(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}class ${constructor(){this.currentPosition={x:0,y:0,z:0,e:0},this.lastPosition={x:0,y:0,z:0,e:0},this.layers=new Map,this.bounds={min:{x:1/0,y:1/0,z:1/0},max:{x:-1/0,y:-1/0,z:-1/0}}}parseCoordinates(n){const e={};for(const u of n){const s=u.charAt(0).toLowerCase();"xyzef".includes(s)&&(e[s]=parseFloat(u.slice(1)))}return e}calculateDistance(n,e){const u=e.x-n.x,s=e.y-n.y,i=e.z-n.z;return Math.sqrt(u*u+s*s+i*i)}updateBounds(n){this.bounds.min.x=Math.min(this.bounds.min.x,n.x),this.bounds.min.y=Math.min(this.bounds.min.y,n.y),this.bounds.min.z=Math.min(this.bounds.min.z,n.z),this.bounds.max.x=Math.max(this.bounds.max.x,n.x),this.bounds.max.y=Math.max(this.bounds.max.y,n.y),this.bounds.max.z=Math.max(this.bounds.max.z,n.z)}async convertToGeometry(n,e={}){const{sampleRate:u=1,simplifyThreshold:s=.1,maxPoints:i=1e6}=e,y=n.split(`
`);let l=0,f=0,o=0;this.currentPosition={x:0,y:0,z:0,e:0},this.lastPosition={x:0,y:0,z:0,e:0},this.layers.clear(),this.bounds={min:{x:1/0,y:1/0,z:1/0},max:{x:-1/0,y:-1/0,z:-1/0}};for(const c of y){if(o++,o%u!==0)continue;const r=c.trim();if(!r||r.startsWith(";"))continue;const d=r.split(" "),T=d[0];if(T==="G0"||T==="G1"){const h=this.parseCoordinates(d);if(h.x!==void 0&&(this.currentPosition.x=h.x),h.y!==void 0&&(this.currentPosition.y=h.y),h.z!==void 0&&(this.currentPosition.z!==h.z&&(f=h.z),this.currentPosition.z=h.z),h.e!==void 0&&(this.currentPosition.e=h.e),this.calculateDistance(this.lastPosition,this.currentPosition)>s){const D=this.currentPosition.e>this.lastPosition.e?"extrude":"travel";this.layers.has(f)||this.layers.set(f,{points:[],lines:[],moveTypes:[]});const g=this.layers.get(f);g.points.push(this.lastPosition.x,this.lastPosition.y,this.lastPosition.z,this.currentPosition.x,this.currentPosition.y,this.currentPosition.z);const C=g.points.length/3-2;if(g.lines.push(C,C+1),g.moveTypes.push(D),this.updateBounds(this.currentPosition),this.lastPosition={...this.currentPosition},l++,l>=i)break}}}const a=Array.from(this.layers.entries()).sort(([c],[r])=>c-r).map(([c,r])=>({z:c,...r}));return{layers:a,bounds:this.bounds,stats:{totalLayers:a.length,totalPoints:l}}}}k(new $);
